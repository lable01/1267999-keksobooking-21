(()=>{"use strict";(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),r=()=>{o.remove(),document.removeEventListener("keydown",n)},n=e=>{"Escape"===e.key&&(e.preventDefault(),r(),document.removeEventListener("keydown",n))};window.card={create:a=>{const d=t.querySelector(".map__card");d&&d.remove();const c=document.createDocumentFragment();c.appendChild((e=>(o.querySelector("h3").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.adress,o.querySelector(".popup__text--price").textContent=`${e.offer.price} ₽/ночь`,o.querySelector(".popup__type").textContent=e.offer.adsTypeRus,o.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,o.querySelector(".popup__features").innerHTML="",o.querySelector(".popup__features").appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+e,t.appendChild(o)})),t})(e.offer.features)),o.querySelector(".popup__description").textContent=e.offer.description,o.querySelector(".popup__photos").innerHTML="",o.querySelector(".popup__photos").appendChild((e=>{const t=document.createDocumentFragment(),o=document.querySelector("#card").content.querySelector(".popup__photo");return e.forEach((e=>{const r=o.cloneNode(!0);r.src=e,t.appendChild(r)})),t})(e.offer.photos)),o.querySelector(".popup__avatar").src=e.author.avatar,o.querySelector(".popup__close").addEventListener("click",(()=>{r()})),document.addEventListener("keydown",n),o))(a)),t.insertBefore(c,e)},remove:r}})(),window.data={Coordinates:{X_MIN:0,X_MAX:1200,Y_MIN:130,Y_MAX:630},adsTypeRus:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}},window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),d=t.querySelector("#housing-features"),c=t=>(t=>t.offer.type===o.value||o.value===e)(t)&&(e=>{switch(r.value){case"low":return e.offer.price<1e3;case"middle":return e.offer.price>=1e3&&e.offer.price<=5e4;case"high":return e.offer.price>=5e4}return!0})(t)&&(t=>t.offer.rooms===+n.value||n.value===e)(t)&&(t=>t.offer.guests===+a.value||a.value===e)(t)&&(e=>{const t=d.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(t);t.addEventListener("change",(()=>{(()=>{const e=window.dataMain.filter(c);window.pin.remove(),window.debounce(window.main.renderPins(e.slice(0,window.main.PINS_COUNT)))})(),window.card.remove()})),window.filter={reset:()=>{t.reset()}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("main"),o=document.querySelector("#room_number"),r=document.querySelector("#capacity"),n=document.querySelector("#price"),a=document.querySelector("#timein"),d=document.querySelector("#timeout"),c=document.querySelector("#type"),i=document.querySelector("#address"),s=document.querySelector("#success"),l={bungalow:0,flat:1e3,house:5e3,palace:1e4},u={bungalow:999,flat:4999,house:9999,palace:1/0},m={1:[1],2:[1,2],3:[1,2,3],100:[0]},p=e=>{const t=r.querySelectorAll("option");t.forEach((e=>{e.disabled=!0})),m[e].forEach((e=>{t.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))},f=e=>{a.value=e.target.value,d.value=e.target.value};a.addEventListener("change",f),d.addEventListener("change",f),c.addEventListener("change",(()=>{n.placeholder=l[c.value],n.setAttribute("min",l[c.value]),n.setAttribute("max",u[c.value])})),o.addEventListener("change",(()=>{p(o.value)}));const w=()=>{const e=s.content.querySelector(".success").cloneNode(!0);t.appendChild(e);const o=()=>{e.remove(),document.removeEventListener("click",o)};document.addEventListener("click",o);const r=t=>{"Escape"===t.key&&e.remove(),document.removeEventListener("keydown",r)};document.addEventListener("keydown",r)},v=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.appendChild(e),e.querySelector(".error__button").addEventListener("click",(()=>{e.remove()})),e.addEventListener("click",(()=>{e.remove()}));const o=t=>{"Escape"===t.key&&e.remove(),document.removeEventListener("keydown",o)};document.addEventListener("keydown",o)},y=()=>{window.main.deactivateForm(),window.map.main.classList.add("map--faded"),e.classList.add("ad-form--disabled"),window.card.remove(),window.pin.remove(),e.reset(),window.filter.reset(),window.map.pinMain.addEventListener("click",window.main.onLoadMap)};e.addEventListener("submit",(t=>{window.server.uploadData(new FormData(e),w,v),t.preventDefault(),y(),window.map.setMainPinCenter()})),e.addEventListener("reset",(()=>{y()})),window.form={ad:e,roomNumber:o,allElementsDisabled:e=>{e.forEach((e=>{e.setAttribute("disabled","disabled")}))},allElementsActivate:e=>{e.forEach((function(e){e.removeAttribute("disabled")}))},addAddressCoords:e=>{i.value=e},checkRooms:p}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview"),r=document.querySelector("#images"),n=document.querySelector(".ad-form__photo"),a=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){if(null===o.querySelector("img")){const t=document.createElement("img");t.src=e.result,t.alt="Фото объявления",t.style="width: 65px; height: 65px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)",o.style.position="relative",o.appendChild(t)}else o.querySelector("img").src=e.result})),e.readAsDataURL(r)}};t.addEventListener("change",(()=>{a(t,o)})),r.addEventListener("change",(()=>{a(r,n)}))})(),(()=>{const e=window.form.ad.querySelector(".ad-form-header"),t=window.form.ad.querySelectorAll(".ad-form__element"),o=document.querySelectorAll(".map__filter"),r=document.querySelector(".map__pins"),n=e=>{const t=document.createDocumentFragment();e.forEach((e=>{t.appendChild(window.pin.render(e))})),r.appendChild(t)},a=()=>{e.setAttribute("disabled","disabled"),window.form.allElementsDisabled(t),window.form.allElementsDisabled(o)};a();const d=()=>{window.server.loadData((r=>{window.map.main.classList.remove("map--faded"),window.form.ad.classList.remove("ad-form--disabled"),e.removeAttribute("disabled"),window.form.allElementsActivate(o),window.form.allElementsActivate(t),window.form.addAddressCoords(window.map.getPinCoords()),window.map.pinMain.removeEventListener("click",d),n(r.slice(0,5)),window.dataMain=r,window.form.checkRooms(window.form.roomNumber.value)}),(e=>{const t=document.createElement("div");t.style="z-index: 3; margin: 0 auto; text-align: center; background-color: green;",t.style.position="absolute",t.style.fontSize="18px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))};window.map.pinMain.addEventListener("click",d),window.main={PINS_COUNT:5,deactivateForm:a,onLoadMap:d,renderPins:n}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{const o=e.cloneNode(!0);o.style.left=t.location.x-40/window.util.COORDINAT_COEFFICIENT+"px",o.style.top=t.location.y-40+"px",o.querySelector("img").src=t.author.avatar,o.alt=t.offer.title;const r=()=>{window.card.create(t);const e=document.querySelectorAll(".map__pin--active");e?(e.forEach((e=>{e.classList.remove("map__pin--active")})),o.classList.add("map__pin--active")):o.classList.add("map__pin--active")};return o.addEventListener("click",r),o.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),r()),"Escape"===e.key&&(e.preventDefault(),r())})),o},remove:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),window.server={loadData:(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},uploadData:(e,t,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):o()})),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)}},(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={getRandomNumber:e,getRandomArray:t=>t.filter((function(){return e(0,t.length-1)})),COORDINAT_COEFFICIENT:2}})()})();